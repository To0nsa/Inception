# Redirect all HTTP (port 80) traffic to HTTPS
server {
    listen 80;                              # Listen on port 80 (HTTP)
    server_name nlouis.42.fr;               # Only respond to this domain
    return 301 https://$host$request_uri;   # Permanent redirect to HTTPS, preserving path/query
}

# Primary HTTPS server block
server {
    listen 443 ssl;                    # Listen on port 443 with SSL/TLS
    server_name nlouis.42.fr;          # Only respond to this domain

    # Document root and index files
    root /var/www/html;                # Files to serve live here (WordPress files)
    index index.php index.html;        # Try index.php first, then index.html

    # TLS configuration
    ssl_certificate     /run/secrets/ssl_cert;        # Public certificate
    ssl_certificate_key /run/secrets/ssl_key;         # Private key
    ssl_protocols       TLSv1.2 TLSv1.3;              # Only allow TLS 1.2 and 1.3
    ssl_ciphers         HIGH:!aNULL:!MD5;             # Strong ciphers, no anonymous/DSS/MD5

    # Serve static files or pass to WordPress front controller
    location / {
        try_files $uri $uri/ /index.php?$args;
        # 1) If request matches a file ($uri), serve it.
        # 2) Else if matches a directory ($uri/), serve it.
        # 3) Otherwise internally rewrite to /index.php, passing original query.
    }

    # PHP‐FPM FastCGI handling for *.php files
    location ~ \.php$ {
        include fastcgi_params;                             # Standard FastCGI header setup
        fastcgi_pass   wordpress:9000;                      # Send to PHP‐FPM container on port 9000
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
                                                            # Tell PHP the real filesystem path
        fastcgi_param  HTTPS           on;                  # Let WordPress know the request is HTTPS
    }

    # Deny access to hidden files (e.g. .htaccess, .git)
    location ~ /\.(?!well-known).* {
        deny all;     # Return 403 for any request to a dot-file except .well-known
    }
}
